name: Install Script Test

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'install.sh'
      - '.github/workflows/install-script-test.yaml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'install.sh'
      - '.github/workflows/install-script-test.yaml'
  workflow_dispatch:
  schedule:
    # Run weekly to catch any issues with new releases
    - cron: '0 0 * * 0'

jobs:
  test-install-script:
    name: Test install.sh on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          # Linux ARM64 (requires GitHub Enterprise or GitHub Team plan)
          # Uncomment if you have access to ARM64 runners
          # - os: linux
          #   arch: arm64
          #   runner: ubuntu-latest-arm64
          # macOS AMD64
          - os: darwin
            arch: amd64
            runner: macos-13
          # macOS ARM64
          - os: darwin
            arch: arm64
            runner: macos-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Test install script (latest release)
        continue-on-error: true
        id: test-latest
        run: |
          # Helper function to verify binary installation
          verify_binary() {
            local install_dir=$1
            local binary_path="${install_dir}/git-drs"
            
            # Verify the binary was installed
            if [ ! -f "${binary_path}" ]; then
              echo "❌ git-drs binary not found at ${binary_path}"
              return 1
            fi
            
            # Verify the binary is executable
            if [ ! -x "${binary_path}" ]; then
              echo "❌ git-drs binary is not executable"
              return 1
            fi
            
            # Test that the binary can run
            "${binary_path}" --version || "${binary_path}" --help
            return 0
          }
          
          echo "Testing install.sh with latest release on ${{ matrix.os }} ${{ matrix.arch }}"
          
          # Create a temporary directory for installation
          INSTALL_DIR="${HOME}/test-install-latest"
          mkdir -p "${INSTALL_DIR}"
          
          # Run the install script
          if bash ./install.sh "" "${INSTALL_DIR}"; then
            if verify_binary "${INSTALL_DIR}"; then
              echo "✅ Install script test passed for latest release"
            else
              exit 1
            fi
          else
            echo "ℹ️  Install script failed for latest release (may not have release assets for this platform)"
            exit 0
          fi

      - name: Get list of recent releases
        id: get-releases
        run: |
          # Get the latest 3 release tags
          TAGS=$(git ls-remote --tags https://github.com/${{ github.repository }}.git | \
                 grep -v '\^{}' | \
                 awk '{print $2}' | \
                 sed 's|refs/tags/||' | \
                 sort -V | \
                 tail -3)
          
          # Convert to JSON array for matrix
          echo "Found tags: $TAGS"
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Test install script with specific versions
        if: steps.get-releases.outputs.tags != ''
        run: |
          # Helper function to verify binary installation
          verify_binary() {
            local install_dir=$1
            local binary_path="${install_dir}/git-drs"
            
            if [ ! -f "${binary_path}" ]; then
              echo "❌ git-drs binary not found at ${binary_path}"
              return 1
            fi
            
            if [ ! -x "${binary_path}" ]; then
              echo "❌ git-drs binary is not executable"
              return 1
            fi
            
            "${binary_path}" --version || "${binary_path}" --help
            return 0
          }
          
          TAGS="${{ steps.get-releases.outputs.tags }}"
          
          for TAG in $TAGS; do
            echo "Testing install.sh with version $TAG on ${{ matrix.os }} ${{ matrix.arch }}"
            
            # Create a temporary directory for installation
            INSTALL_DIR="${HOME}/test-install-${TAG}"
            mkdir -p "${INSTALL_DIR}"
            
            # Run the install script with specific version
            if bash ./install.sh "$TAG" "${INSTALL_DIR}"; then
              if verify_binary "${INSTALL_DIR}"; then
                echo "✅ Install script test passed for version $TAG"
              else
                exit 1
              fi
            else
              echo "ℹ️  Install script failed for version $TAG (may not have release assets for this platform)"
            fi
          done

      - name: Test install script with v-prefix version
        if: steps.get-releases.outputs.tags != ''
        run: |
          # Helper function to verify binary installation
          verify_binary() {
            local install_dir=$1
            local binary_path="${install_dir}/git-drs"
            
            if [ ! -f "${binary_path}" ]; then
              echo "❌ git-drs binary not found at ${binary_path}"
              return 1
            fi
            
            if [ ! -x "${binary_path}" ]; then
              echo "❌ git-drs binary is not executable"
              return 1
            fi
            
            "${binary_path}" --version || "${binary_path}" --help
            return 0
          }
          
          TAGS="${{ steps.get-releases.outputs.tags }}"
          
          # Find a tag without v-prefix to test v-prefix handling
          TAG_WITHOUT_V=""
          TAG_WITH_V=""
          
          for TAG in $TAGS; do
            if [[ $TAG != v* ]]; then
              TAG_WITHOUT_V="$TAG"
              TAG_WITH_V="v${TAG}"
              break
            fi
          done
          
          # If all tags have v-prefix, use the first one to test normalization
          if [ -z "$TAG_WITHOUT_V" ]; then
            TAG_WITH_V=$(echo "$TAGS" | head -1)
            echo "Testing install.sh with existing v-prefixed version $TAG_WITH_V on ${{ matrix.os }} ${{ matrix.arch }}"
          else
            echo "Testing install.sh with v-prefixed version $TAG_WITH_V (original: $TAG_WITHOUT_V) on ${{ matrix.os }} ${{ matrix.arch }}"
          fi
          
          # Create a temporary directory for installation
          INSTALL_DIR="${HOME}/test-install-v-prefix"
          mkdir -p "${INSTALL_DIR}"
          
          # Run the install script with v-prefixed version
          if bash ./install.sh "$TAG_WITH_V" "${INSTALL_DIR}"; then
            if verify_binary "${INSTALL_DIR}"; then
              echo "✅ Install script test passed for v-prefixed version $TAG_WITH_V"
            else
              exit 1
            fi
          else
            echo "ℹ️  Install script failed for v-prefixed version $TAG_WITH_V (may not have release assets for this platform)"
          fi

  test-install-script-cross-arch:
    name: Test install.sh cross-architecture simulation
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Test architecture detection behavior
        run: |
          echo "Testing architecture detection behavior in install.sh"
          
          # Create a test script that extracts and runs the architecture detection logic
          cat > /tmp/test_arch.sh << 'EOF'
          #!/bin/bash
          ARCH=$(uname -m)
          
          if [ "$ARCH" == "x86_64" ]; then
            ARCH="amd64"
          elif [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]]; then
            ARCH="arm64"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi
          
          echo "$ARCH"
          EOF
          
          chmod +x /tmp/test_arch.sh
          DETECTED_ARCH=$(/tmp/test_arch.sh)
          echo "Detected architecture: $DETECTED_ARCH"
          
          # Verify the detected architecture is valid
          if [[ "$DETECTED_ARCH" == "amd64" || "$DETECTED_ARCH" == "arm64" ]]; then
            echo "✅ Architecture detection logic works correctly"
          else
            echo "❌ Architecture detection failed"
            exit 1
          fi
          
          # Verify the install.sh script contains architecture detection logic
          if grep -q 'uname -m' install.sh && \
             grep -q 'amd64' install.sh && \
             grep -q 'arm64' install.sh; then
            echo "✅ Install script contains architecture detection logic"
          else
            echo "❌ Install script missing architecture detection"
            exit 1
          fi

      - name: Test version normalization behavior
        run: |
          echo "Testing version normalization behavior"
          
          # Test the bash parameter expansion for removing 'v' prefix
          TEST_VERSION_1="v1.2.3"
          NORMALIZED_1="${TEST_VERSION_1#v}"
          
          TEST_VERSION_2="1.2.3"
          NORMALIZED_2="${TEST_VERSION_2#v}"
          
          if [ "$NORMALIZED_1" == "1.2.3" ] && [ "$NORMALIZED_2" == "1.2.3" ]; then
            echo "✅ Version normalization with '#v' works correctly"
          else
            echo "❌ Version normalization test failed"
            exit 1
          fi
          
          # Verify the install.sh script contains version normalization logic
          # Look for the pattern that removes 'v' prefix using bash parameter expansion
          if grep -q '#v' install.sh && grep -q 'VERSION' install.sh; then
            echo "✅ Install script contains version normalization logic"
          else
            echo "❌ Install script missing version normalization"
            exit 1
          fi

  report-results:
    name: Report Test Results
    needs: [test-install-script, test-install-script-cross-arch]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-install-script.result }}" == "success" ] && \
             [ "${{ needs.test-install-script-cross-arch.result }}" == "success" ]; then
            echo "✅ All install script tests passed!"
          else
            echo "❌ Some install script tests failed"
            echo "test-install-script: ${{ needs.test-install-script.result }}"
            echo "test-install-script-cross-arch: ${{ needs.test-install-script-cross-arch.result }}"
            exit 1
          fi
